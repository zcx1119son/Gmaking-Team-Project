import { useLocation } from "react-router-dom";
import { matchRoutes } from "react-router";
import { useMemo } from "react";

/**
 * 항상 { text: string, cta?: {label, action, key} } 형태로 반환합니다.
 * action: "openGuide" | (필요시 확장)
 */
const GUIDE_RULES = [
  {
    pattern: "/",
    guide: {
      text:
        `여기는 메인 페이지야. 메인 페이지는 웹사이트의 얼굴이라고 할 수 있지. 그 사이트의 첫인상을 좌우하는 곳이 메인 페이지야.
        우리 메인 페이지 어때? 예쁘지?
        헤더를 통해서 우리 주요 컨텐츠로 이동 할 수 있고 메인 하단 중앙에는 네 대표 캐릭터의 정보를 띄워줘.
        대표 캐릭터가 없다면 캐릭터를 만들거나 마이 페이지에서 대표 캐릭터를 설정해봐!`,
    },
  },

  {
    pattern: "/chat-entry/*",
    guide: {
      text:
        `이곳은 채팅 입장 페이지야. 이곳에서 캐릭터를 고르고 채팅방에 입장을 할 수 있어.
        채팅방은 너와 캐릭터 둘이서만 쓸 수 있는 고유의 방이라고 생각하면 돼. 만약 그 캐릭터와 한 번도 대화를 해본 적이 없다면, 방을 준비하는데 시간이 조금 걸릴 수 있어.
        백엔드에서 방을 준비하고 네 캐릭터의 성격과 배경을 바탕으로 페르소나를 생성하고 AI가 첫 인사를 준비하고 있거든!
        조금 시간이 걸려도 인내심을 가지고 기다려줘!
        채팅 AI와 채팅 컨텐츠에 대해서 좀 더 자세히 알고 싶으면 **채팅 AI 알아보기**를 클릭해봐!`,
      cta: { label: "채팅 AI 알아보기", action: "openGuide", key: "chat" },
    },
  },

  {
    pattern: "/chat/*",
    guide: {
      text:
        `이 페이지는 쳇 페이지야. 이곳에서는 캐릭터와 채팅을 할 수 있어. 캐릭터는 각자 고유의 페르소나가 있어서, 페르소나에 따라 말투나 태도가 다 다를거야.
        그리고 API로 가져 온 AI 모델은 기억을 할 수 없다는 것을 알고 있니? 네가 방금 전에 한 말을 기억 못할 수 도 있어. 하지만 걱정하지마. 겜만중의 캐릭터가 널 잊는 슬픈 일은 없을거야.
        캐릭터가 너와의 대화를 기억하고 대화의 맥락을 유지할 수 있도록 DB가 대신 기억하고 프롬프트에 넘겨주고 있거든!
        대화가 길어지면 너와의 대화를 요약해 저장하고, 네가 불러달라고 한 호칭이나 좋아하는 것, 싫어하는 것들의 경우 특별히 영구 기억을 위한 저장소에 저장을 해두고 있어. 대화를 많이 하면 할수록 우리 캐릭터는 똑똑해지고 친근한 너의 친구가 되어갈거야!
        더 자세한 설명이 알고 싶으면 **채팅 AI 알아보기**를 선택해 봐.`,
      cta: { label: "채팅 AI 알아보기", action: "openGuide", key: "chat" },
    },
  },

  {
    pattern: "/battlemode",
    guide: {
      text:
        `이 페이지는 우리 사이트에 존재하는 게임을 전부 볼 수 있는 목록 페이지야. 원하는 게임을 선택해 봐!
        PvP | PvE | 토론배틀 | 미니게임 이렇게 준비되어 있어. 원하는 게임을 선택해 봐. 모두 AI 활용 요소가 들어있으니 즐겨 봐!
        간략하게 설명하자면, PvP는 플레이어와의 실시간 전투를 할 수 있고, PvE는 몬스터를 사냥하고 성장할 수 있어. 캐릭터를 성장할때 PvE 클리어 횟수가 중요해. 토론 배틀은 캐릭터들이 토론하고 AI 2대장이 승패를 판정해 줘. 미니게임은 캐릭터를 성장시킬때 해야하는 게임들을 체험해볼 수 있어.
        더 자세한 내용이 궁금하다면 **자세히 보기** 버튼을 클릭해 봐!`,
      cta: { label: "자세히 보기", action: "showModes" },
    },
  },

  {
    pattern: "/pve/maps",
    guide: {
      text:
        `이 페이지는 PVE 게임의 맵선택 페이지야. 이곳에서 PVE에 참여할 캐릭터와 맵을 선택하면 돼! PVE는 캐릭터를 성장시키고 더 강하게 만들기 위해서 반드시 필요한 게임이야. PVE 클리어 횟수가 부족하면 캐릭터를 성장시킬 수 없어.
        현재 맵은 바다와 산, 숲, 그리고 평원이 준비되어있어. 원하는 맵을 선택하고 네 캐릭터와 함께 여행을 떠나 봐!
        PVE에 대해 자세한 설명을 듣고 싶으면 **PVE AI 알아보기**를 클릭해 봐.`,
      cta: { label: "PVE AI 알아보기", action: "openGuide", key: "pve" },
    },
  },

  {
    pattern: "/pve/battle",
    guide: {
      text: `이 페이지는 PVE 전투 페이지야. 해설 스타일을 선택하면 프롬프트가 네 선택에 맞게 바뀌고, AI가 네 프롬프트에 맞게 전투 상황을 해설해 줘.
      매 턴마다 AI는 전투 상황을 해설하고, 실제 RPG 게임처럼 박진감 넘치는 해설로 네 몰입감을 높혀줄 거야. 그리고 혹시 글씨를 읽기가 힘들다면, 음성 해설을 켜 봐. TTS 기능으로 전투 로그를 AI가 읽어줄거야.
      PVE에서 상대로 마주치게 되는 건 일반 몬스터와 보스 몬스터야. AI가 서버에서 설정한 확률 로직에 따라 일반 몬스터나 보스 몬스터를 매칭해줄거야.
      전투 종료 후에 모든 턴 로그 결과는 DB에 저장 돼. 몬스터에게 승리할 시 캐릭터 스테이지 클리어 횟수가 증가되고, 이는 캐릭터를 성장시키는 데 필수적이야!
      PVE에 대해서 좀 더 자세한 설명을 듣고 싶다면 **PVE AI 알아보기**를 클릭해 봐.`,
      cta: { label: "PVE AI 알아보기", action: "openGuide", key: "pve" },
    },
  },

  {
    pattern: "/pvp/match",
    guide: {
      text: `이 페이지는 PvP 전투를 진행하기 전에 상대를 선택하는 페이지야. 상대방 찾기를 누르고 상대 캐릭터를 선택하고 전투 시작을 눌러 봐. 간단하지?
      하지만 백엔드에서는 상당히 바쁘게 움직이고 있어. 상대방 찾기를 누르면 매칭이 가능한 상대 유저를 랜덤으로 선택하고 유저의 캐릭터들을 가져오거든. 매칭된 상대가 마음에 들지 않는다면 다시 상대방을 찾아 봐.
      싸우고 싶은 상대를 만났다면 내 캐릭터와 상대 캐릭터를 선택하고 전투를 시작해!
      좀 더 자세한 설명을 원한다면 **PVP AI 알아보기**를 클릭해 봐.`,
      cta: { label: "PVP AI 알아보기", action: "openGuide", key: "pvp" },
    },
  },

  {
    pattern: "/pvp/:battleId",
    guide: ({ params }) => ({
      text: `여기는 본격적인 전투가 이루어지는 PvP 배틀 페이지야.
      규칙은 간단해. 공격 | 방어 | 회피 | 필살기 이 네 개의 커맨드 중의 하나를 고르고 턴 실행을 누르면 상대 캐릭터의 AI도 하나의 커맨드를 선택해.
      양 쪽이 선택한 커맨드에 따라 피해량과 승패가 결졍되는 거야. 백엔드에서 이를 인식하고 알고리즘으로 이것을 계산해주면 AI가 결과를 받아서 해설해 줘!
      생동감 있는 AI의 해설덕분에 마치 실제 대전을 중계로 보고 있는 듯한 몰입감을 느낄 수 있을거야!
      전투가 끝나면 결과는 백엔드에 전부 저장되고 상대방에게도 실시간 알림이 전송돼. 만약 상대방이 온라인이라면 화나서 바로 재대결을 신청할지도 몰라!
      전투 결과와 로그를 상대방도 실시간으로 받아 볼 수 있거든.
      좀 더 자세한 설명을 원한다면 **PVP AI 알아보기**를 클릭해 봐.`,
      cta: { label: "PVP AI 알아보기", action: "openGuide", key: "pvp" },
    }),
  },

  {
    pattern: "/debate",
    guide: ({ params }) => ({
      text: `여기는 AI가 토론 배틀을 벌이는 토론장이야.
      참여할 캐릭터를 선택하고 주제를 입력하면 캐릭터들의 성격을 바탕으로 AI가 그 캐릭터인 것처럼 주제에 대해 토론 해.
      토론이 끝나면 세 종류의 AI 모델이 전체 대화를 분석하여 각각의 판단을 내리고 승패를 결정해.
      Gemini: 논리와 설득력 중심의 분석,\n\n\nGPT-4o: 논리와 설득력 중심의 분석,\n\n\nGPT-o1: 간결 객관적인 요약형 판정
      이 세 AI의 투표 결과를 합산하여 다수가 선택한 쪽이 최종 승자가 돼! 흥미로운 토론을 이용해봐.
      좀 더 자세한 설명을 보고 싶다면 **AI 토론 알아보기**를 클릭해 봐.`,
      cta: { label: "AI 토론 알아보기", action: "openGuide", key: "debate" },
    }),
  },

  {
    pattern: ("/logs", "/logs/turns/*"),
    guide: ({ params }) => ({
      text: `이 페이지는 로그 페이지야. PVE와 PVP, 로그 전투 게임인 두 개임의 로그를 모아 볼 수 있어.
      혹시 기억하고 싶은 전투가 있었거나, 내가 모르는 사이에 벌어진 PVP의 결과의 로그를 여기서 확인해 봐!`,
    }),
  },

  {
    pattern: "/shop",
    guide: { text: `여긴 상점 페이지야! 우리 사이트는 지금 광고 제거 패스권과 부화기 패키지를 살 수 있어.
    광고 제거 패스는 **30일**동안 광고가 제거 돼. 게임을 진행할때 나타나는 광고가 신경쓰인다면 고려해볼만 하지! 광고는 겜만중이 운영되게 해주는 고마운 존재거든. 그래서 내가 무단으로 네 광고를 제거해줄 수는 없어. 광고 제거 패스를 구매해서 줘. 그럼 광고가 제거 되게 해줄게.
    부화기는 중요한 캐릭터를 부화시키는데 1개씩 사용 돼. 부화기는 매일 1개씩 무료로 지급되지만, 하루에 1개로 만족하지 못하겠다면 유료 부화기를 구매하는 것을 고려해봐!` },
  },
  {
    pattern: "/my-page",
    guide: { text: `여기는 마이 페이지야! … 더보기 아이콘을 클릭하면 회원정보를 수정할 수 있어! 우리 사이트에서 너를 상징할 프로필 이미지와 닉네임을 자유롭게 등록하고 수정해봐!
    보유하고 있는 아이템과 캐릭터들도 마이페이지에서 볼 수 있어. 캐릭터를 선택해서 내 캐릭터의 스텟을 확인하고 성장시켜봐. 참 성장은 PVE 게임을 일정 횟수 클리어해야 가능해` },
  },

  {
      pattern: "/ranking",
      guide: {
        text:
          `여기는 랭킹 페이지야. 우리 사이트에 존재하는 모든 캐릭터의 순위를 확인할 수 있지. 자신의 캐릭터 순위를 확인해봐! 만족스럽지 않다면, 다시 캐릭터를 부화시키거나 성장시켜봐.`,
      },
  },

  {
    pattern: "/community",
    guide: {
      text:
        `여기는 커뮤니티 페이지야. 여기서 유저들과 소통하고 내 캐릭터를 자랑할 수 있어! 글쓰기 버튼을 눌러 글을 쓰고 다른 사람들의 글에 댓글을 달아 봐.
        커뮤니티가 활성화 될수록 복작복작해질거야. 네가 글과 댓글로 우리 커뮤니티에 활기를 불어 넣어줄래?`,
    },
  },

  {
    pattern: "/create-character",
    guide: {
      text:
        `이곳은 캐릭터 생성 페이지야. 이 페이지에서는 무려 두 개의 AI 모델이 작동해.
        첫 번째 AI 모델은 곰, 독수리, 펭귄, 거북이 이미지를 사용자가 입력하면 분류해주는 학습 모델이야. 우리가 직접 학습시킨 하나뿐인 모델이라구!
        두 번째 AI 모델은 챗지피티야. 첫번째 AI가 분류해낸 결과에 따라 캐릭터 이미지를 생성해줘. 두가지 AI가 협력해서 하나의 캐릭터를 탄생시키는 거지.
        이미지와 이름, 그리고 원한다면 추가 프롬프트에 네가 원하는 캐릭터를 묘사해주고 캐릭터 생성 미리보기를 누르기만 하면 너만의 캐릭터가 태어날 거야.
        물론, 완전히 무료는 아니야. 한 번 캐릭터를 생성할 때마다 부화권을 하나씩 소모해야 해. 하루에 하나씩 무료 부화권이 지급되지만 부족하다면 **상점**에서 부화권을 구매해 봐!`,
    },
  },

  {
    pattern: "/minigame",
    guide: {
      text:
        `성장에 필요한 간단한 게임들을 체험해봐! 반응속도 테서트, 기억력 게임, 타이핑 배틀 등 다양한 게임을 즐겨볼 수 있어. 나중에 성장할때 이 게임이 필요하니까 미리 해보는게 좋을거야!`,
    },
  },
];

export default function usePageGuide() {
  const location = useLocation();

  return useMemo(() => {
    const matches = matchRoutes(
      GUIDE_RULES.map((r) => ({ path: r.pattern })),
      location
    );
    if (!matches?.length)
      return { text: "이 페이지에 대한 설명을 아직 준비하지 못했어요." };

    const match = matches[matches.length - 1];
    const rule = GUIDE_RULES.find((r) => r.pattern === match.route.path);
    if (!rule) return { text: "이 페이지에 대한 설명을 아직 준비하지 못했어요." };

    const g =
      typeof rule.guide === "function"
        ? rule.guide({ params: match.params, location })
        : rule.guide;

    // 항상 {text, cta?} 형태 보장
    return typeof g === "string" ? { text: g } : g;
  }, [location]);
}
